<!DOCTYPE html>
<html>
<head>
  <title>USYD Metacognition</title>

  <!-- Load jsPsych and jquery-->
  <script src="https://unpkg.com/jspsych@7.2.1"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/js/foundation.min.js'></script>
  <link href="https://unpkg.com/jspsych@7.2.3/css/jspsych.css" rel="stylesheet" type="text/css" />


  <!-- Load jsPsych plugins-->
  <script src="https://unpkg.com/@jspsych/plugin-instructions@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-button-response@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-external-html@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>

  <!-- Load the global environment-->
  <script src="global-env.js"></script>
  <script src="info_sheets.js"></script>
  <script src="helper-functions.js"></script>

  <!-- Load custom plugins from directory-->




</head>
<body></body>
<script>



//////////////////////////////////
//         Gloabl Settings      //
//////////////////////////////////

// Initalise jsPsych
  const jsPsych = initJsPsych({
    on_finish: function(data) {
     if(jsPsych.data.get().select('accuracy').mean() < 0.50){window.location = attention_redirect_link} else {window.location = redirect_link}
   }
 })


// Settings
  const redirect_link ="https://app.prolific.co/submissions/complete?cc=CHGWKNI0"

 const attention_redirect_link ="https://app.prolific.co/submissions/complete?cc=C13PIUOF" // A seperate link for those who fail the attention check


// Capture any url paramaters
  const PROLIFIC_PID = jsPsych.data.getURLVariable('PROLIFIC_PID');
  const SONA_PID = jsPsych.data.getURLVariable('id');

jsPsych.data.addProperties({participant_id: PROLIFIC_PID});

  
  // Save to OSF
  const subject_id = jsPsych.randomization.randomID(10);
  const filename = `${subject_id}.csv`;



  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "NiAZxGe1LX8K",
    filename: filename,
    data_string: ()=>jsPsych.data.get().csv()
  };



// Global Variables
  const choices = jsPsych.randomization.shuffle(['Blicket', 'Daxe']);
const labels = jsPsych.randomization.shuffle(['Blicket', 'Daxe']);
const match_label = labels[0];
const Nomatch_label = labels[1];
var blocknum = 1;
var trialnum = 1;
var pilot = jsPsych.data.getURLVariable('pilot');
var wait_time;
var egg;
var RTs = [];
var last_cond = [];
var stim_order = [];
var condition;


//////////////////////////////////





 // Stimuli

var preload = {
    type: jsPsychPreload,
    images: ['img/training/cat1-item1.png','img/training/cat1-item2.png','img/training/cat1-item3.png','img/training/cat1-item4.png','img/training/cat1-item5.png','img/training/cat1-item6.png',
    'img/training/cat2-item7.png','img/training/cat2-item8.png','img/training/cat2-item9.png','img/training/cat2-item10.png','img/training/cat2-item11.png','img/training/cat2-item12.png',
    'img/test/cat1-item1-unambiguous.png', 'img/test/cat1-item2-unambiguous.png', 'img/test/cat1-item3-unambiguous.png', 'img/test/cat1-item4-unambiguous.png', 'img/test/cat1-item5-unambiguous.png', 'img/test/cat1-item6-unambiguous.png',
    'img/test/cat2-item7-unambiguous.png', 'img/test/cat2-item8-unambiguous.png', 'img/test/cat2-item9-unambiguous.png', 'img/test/cat2-item10-unambiguous.png','img/test/cat2-item11-unambiguous.png', 'img/test/cat2-item12-unambiguous.png',
    'img/test/cat2-item1-ambiguous.png','img/test/cat2-item2-ambiguous.png','img/test/cat2-item3-ambiguous.png', 'img/test/cat2-item4-ambiguous.png','img/test/cat2-item5-ambiguous.png','img/test/cat2-item6-ambiguous.png',
    'img/test/cat1-item7-ambiguous.png','img/test/cat1-item8-ambiguous.png','img/test/cat1-item9-ambiguous.png','img/test/cat1-item10-ambiguous.png','img/test/cat1-item11-ambiguous.png','img/test/cat1-item12-ambiguous.png']
}






  // Trials



var CR_training_trial = {
  data: {phase: 'training'},
    timeline: [
        {
          type: jsPsychImageButtonResponse,
          data: {trial_name: 'categorisation', category:  jsPsych.timelineVariable('category'), choice_left: choices[0], choice_right: choices[1], item_index: jsPsych.timelineVariable('item_index'), class: "training-stimuli"},
          stimulus: jsPsych.timelineVariable('shape'),
          choices: choices,
          trial_duration: 8000,
          stimulus_height: 250,
          stimulus_width: 250,
          prompt: function(data){
            console.log(jsPsych.data.get().last(3).values()[0].response)
            if(jsPsych.data.get().last(3).values()[0].response == null & trialnum != 1){return ("<p>What type of shape is this?</p><span style='color: #FF0000;'><br><br>You need to select a response from the buttons above</span>")} else {return "<p>What type of shape is this?</p>"}
          },
          on_finish: function(data){
               if(jsPsych.timelineVariable('category') == "rule-match" & choices[data.response] == match_label |
               jsPsych.timelineVariable('category') == "rule-Nomatch" & choices[data.response] == Nomatch_label){
                 data.correct = true;
               } else {
                 data.correct = false;
               }
               if(data.correct == true){data.accuracy = 1} else {data.accuracy = 0};
               data.choice = choices[data.response]
               data.trialnum = trialnum;
               data.blocknum = blocknum;
         }
            },

            {
          type: jsPsychHtmlSliderResponse,
            data: {trial_name: 'CR', category:  jsPsych.timelineVariable('category'), item_index: jsPsych.timelineVariable('item_index'), class: "ConfidenceRating" },
            stimulus: `<div style="width:500px;">
                <p>How confident are you that you correctly categorised the last shape?</div>
                </div>`,
            require_movement: true,
            labels: ["0%", "20%", '40%', '60%', "80%",'100%'],
            trial_duration: 12000,
          on_finish: function(data){
            data.trialnum = trialnum;
            data.blocknum = blocknum;
          }
        },

            {
            type: jsPsychHtmlKeyboardResponse,
            data: {trial_name: 'feedback', category:  jsPsych.timelineVariable('category'), item_index: jsPsych.timelineVariable('item_index'), class: "feedback" },
            stimulus: function(data){
              if(jsPsych.timelineVariable('category') == "rule-match") {return '<img  width="250" height="250" src = "'+jsPsych.timelineVariable('shape')+'"></img><br><br>This shape is a <b>' + match_label + '</b>'}
              if(jsPsych.timelineVariable('category') == "rule-Nomatch") {return '<img width="250" height="250" src = "'+jsPsych.timelineVariable('shape')+'"></img><br><br>This shape is a <b>' + Nomatch_label + '</b>' }
            },
            choices: "NO_KEYS",
            trial_duration: 2000,
            on_finish: function(data){
              data.trialnum = trialnum;
              data.blocknum = blocknum;
              trialnum = trialnum + 1;
            }
        }
        

    ],
    on_timeline_finish: function(){
      blocknum = blocknum + 1;
      trialnum = 1;
    },
    timeline_variables: [
      { shape: 'img/training/cat1-item1.png', item_index: 0, category: "rule-Nomatch" },
      { shape: 'img/training/cat2-item7.png', item_index: 1, category: "rule-match" },
      { shape: 'img/training/cat1-item2.png', item_index: 2, category: "rule-Nomatch" },
      { shape: 'img/training/cat2-item8.png', item_index: 3, category: "rule-match" },
      { shape: 'img/training/cat1-item3.png', item_index: 4, category: "rule-Nomatch" },
      { shape: 'img/training/cat2-item9.png', item_index: 5, category: "rule-match"},
      { shape: 'img/training/cat1-item4.png', item_index: 6, category: "rule-Nomatch" },
      { shape: 'img/training/cat2-item10.png', item_index: 7, category: "rule-match" },
      { shape: 'img/training/cat1-item5.png', item_index: 8, category: "rule-Nomatch"},
      { shape: 'img/training/cat2-item11.png', item_index: 9, category: "rule-match"},
      { shape: 'img/training/cat1-item6.png', item_index: 10, category: "rule-Nomatch"},
      { shape: 'img/training/cat2-item12.png', item_index: 11, category: "rule-match"}
    ],
    sample: {
       type: 'custom',
       fn: function(t){
         return trippleTreat(t)


       }
}}


var NoCR_training_trial = {
  data: {phase: 'training'},
    timeline: [
        {
          type: jsPsychImageButtonResponse,
          data: {trial_name: 'categorisation', category:  jsPsych.timelineVariable('category'), choice_left: choices[0], choice_right: choices[1], item_index: jsPsych.timelineVariable('item_index'), class: "training-stimuli"},
          stimulus: jsPsych.timelineVariable('shape'),
          choices: choices,
          trial_duration: 8000,
          stimulus_height: 250,
          stimulus_width: 250,
          prompt: function(data){
            console.log(jsPsych.data.get().last(3).values()[0].response)
            if(jsPsych.data.get().last(3).values()[0].response == null & trialnum != 1){return ("<p>What type of shape is this?</p><span style='color: #FF0000;'><br><br>You need to select a response from the buttons above</span>")} else {return "<p>What type of shape is this?</p>"}
          },
          on_finish: function(data){
               if(jsPsych.timelineVariable('category') == "rule-match" & choices[data.response] == match_label |
               jsPsych.timelineVariable('category') == "rule-Nomatch" & choices[data.response] == Nomatch_label){
                 data.correct = true;
               } else {
                 data.correct = false;
               }
               if(data.correct == true){data.accuracy = 1} else {data.accuracy = 0};
               data.choice = choices[data.response]
               data.trialnum = trialnum;
               data.blocknum = blocknum;
         }
            },
        {
          type: jsPsychHtmlKeyboardResponse,
            data: {trial_name: 'waitScreen', category:  jsPsych.timelineVariable('category'),item_index: jsPsych.timelineVariable('item_index'),  class: "waitScreen" },
          stimulus: 'Waiting...',
          choices: "NO_KEYS",
          trial_duration: 1500,
          on_finish: function(data){
            data.trialnum = trialnum;
            data.blocknum = blocknum;

          }
        },
            {
            type: jsPsychHtmlKeyboardResponse,
            data: {trial_name: 'feedback', category:  jsPsych.timelineVariable('category'), item_index: jsPsych.timelineVariable('item_index'), class: "feedback" },
            stimulus: function(data){
              if(jsPsych.timelineVariable('category') == "rule-match") {return '<img  width="250" height="250" src = "'+jsPsych.timelineVariable('shape')+'"></img><br><br>This shape is a <b>' + match_label + '</b>'}
              if(jsPsych.timelineVariable('category') == "rule-Nomatch") {return '<img width="250" height="250" src = "'+jsPsych.timelineVariable('shape')+'"></img><br><br>This shape is a <b>' + Nomatch_label + '</b>'}
            },
            choices: "NO_KEYS",
            trial_duration: 2000,
            on_finish: function(data){
              data.trialnum = trialnum;
              data.blocknum = blocknum;
              data.wait_time = wait_time;
              trialnum = trialnum + 1;
            }
        }
    ],
    on_timeline_finish: function(){
      blocknum = blocknum + 1;
      trialnum = 1;
    },
    timeline_variables: [
      { shape: 'img/training/cat1-item1.png', item_index: 0, category: "rule-Nomatch"},
      { shape: 'img/training/cat2-item7.png', item_index: 1, category: "rule-match"},
      { shape: 'img/training/cat1-item2.png', item_index: 2, category: "rule-Nomatch"},
      { shape: 'img/training/cat2-item8.png', item_index: 3, category: "rule-match"},
      { shape: 'img/training/cat1-item3.png', item_index: 4, category: "rule-Nomatch"},
      { shape: 'img/training/cat2-item9.png', item_index: 5, category: "rule-match"},
      { shape: 'img/training/cat1-item4.png', item_index: 6, category: "rule-Nomatch"},
      { shape: 'img/training/cat2-item10.png', item_index: 7, category: "rule-match"},
      { shape: 'img/training/cat1-item5.png', item_index: 8, category: "rule-Nomatch"},
      { shape: 'img/training/cat2-item11.png', item_index: 9, category: "rule-match"},
      { shape: 'img/training/cat1-item6.png', item_index: 10, category: "rule-Nomatch"},
      { shape: 'img/training/cat2-item12.png', item_index: 11, category: "rule-match"}
    ],
    sample: {
       type: 'custom',
       fn: function(t){
         
          return trippleTreat(t)
        
       }
}}

var test_trial = {
  data: {phase: 'test'},
    timeline: [
        {
          type: jsPsychImageButtonResponse,
          data: {trial_name: 'categorisation', category:  jsPsych.timelineVariable('category'), choice_left: choices[0], choice_right: choices[1], class: jsPsych.timelineVariable('class')},
          stimulus: jsPsych.timelineVariable('shape'),
          choices: choices,
          stimulus_height: 250,
          stimulus_width: 250,
          prompt: "<p>What type of shape is this?</p>",
          on_finish: function(data){
               if(jsPsych.timelineVariable('category') == "rule-match" & choices[data.response] == match_label |
               jsPsych.timelineVariable('category') == "rule-Nomatch" & choices[data.response] == Nomatch_label){
                 data.correct = true;
               } else {
                 data.correct = false;
               }
               if(data.correct == true){data.accuracy = 1} else {data.accuracy = 0};
               data.choice = choices[data.response]
               data.trialnum = trialnum;
               trialnum = trialnum + 1;
               data.blocknum = blocknum;
         }
            }
    ],
    timeline_variables: [
      { shape: 'img/training/cat1-item1.png', category: "rule-Nomatch", class: "seen" },
      { shape: 'img/training/cat1-item2.png', category: "rule-Nomatch", class: "seen"  },
      { shape: 'img/training/cat1-item3.png', category: "rule-Nomatch", class: "seen"  },
      { shape: 'img/training/cat1-item4.png', category: "rule-Nomatch", class: "seen"  },
      { shape: 'img/training/cat1-item5.png', category: "rule-Nomatch", class: "seen"  },
      { shape: 'img/training/cat1-item6.png', category: "rule-Nomatch", class: "seen"  },
      { shape: 'img/training/cat2-item7.png', category: "rule-match", class: "seen"  },
      { shape: 'img/training/cat2-item8.png', category: "rule-match", class: "seen"  },
      { shape: 'img/training/cat2-item9.png', category: "rule-match", class: "seen"  },
      { shape: 'img/training/cat2-item10.png', category: "rule-match", class: "seen"  },
      { shape: 'img/training/cat2-item11.png', category: "rule-match", class: "seen"  },
      { shape: 'img/training/cat2-item12.png', category: "rule-match", class: "seen"  },


      {shape: 'img/test/cat1-item1-unambiguous.png', category: "rule-Nomatch", class: "unambiguous" },
      {shape: 'img/test/cat1-item2-unambiguous.png', category: "rule-Nomatch", class: "unambiguous" },
      {shape: 'img/test/cat1-item3-unambiguous.png', category: "rule-Nomatch", class: "unambiguous" },
      {shape: 'img/test/cat1-item4-unambiguous.png', category: "rule-Nomatch", class: "unambiguous" },
      {shape: 'img/test/cat1-item5-unambiguous.png', category: "rule-Nomatch", class: "unambiguous" },
      {shape: 'img/test/cat1-item6-unambiguous.png', category: "rule-Nomatch", class: "unambiguous" },
      {shape: 'img/test/cat2-item7-unambiguous.png', category: "rule-match", class: "unambiguous" },
      {shape: 'img/test/cat2-item8-unambiguous.png', category: "rule-match", class: "unambiguous" },
      {shape: 'img/test/cat2-item9-unambiguous.png', category: "rule-match", class: "unambiguous" },
      {shape: 'img/test/cat2-item10-unambiguous.png', category: "rule-match", class: "unambiguous" },
      {shape: 'img/test/cat2-item11-unambiguous.png', category: "rule-match", class: "unambiguous" },
      {shape: 'img/test/cat2-item12-unambiguous.png', category: "rule-match", class: "unambiguous" },

      {shape: 'img/test/cat2-item1-ambiguous.png', category: "rule-match", class: "ambiguous" },
      {shape: 'img/test/cat2-item2-ambiguous.png', category: "rule-match", class: "ambiguous" },
      {shape: 'img/test/cat2-item3-ambiguous.png', category: "rule-match", class: "ambiguous" },
      {shape: 'img/test/cat2-item4-ambiguous.png', category: "rule-match", class: "ambiguous" },
      {shape: 'img/test/cat2-item5-ambiguous.png', category: "rule-match", class: "ambiguous" },
      {shape: 'img/test/cat2-item6-ambiguous.png', category: "rule-match", class: "ambiguous" },
      {shape: 'img/test/cat1-item7-ambiguous.png', category: "rule-Nomatch", class: "ambiguous" },
      {shape: 'img/test/cat1-item8-ambiguous.png', category: "rule-Nomatch", class: "ambiguous" },
      {shape: 'img/test/cat1-item9-ambiguous.png', category: "rule-Nomatch", class: "ambiguous" },
      {shape: 'img/test/cat1-item10-ambiguous.png', category: "rule-Nomatch", class: "ambiguous" },
      {shape: 'img/test/cat1-item11-ambiguous.png', category: "rule-Nomatch", class: "ambiguous" },
      {shape: 'img/test/cat1-item12-ambiguous.png', category: "rule-Nomatch", class: "ambiguous" }

    ],
    sample: {
       type: 'custom',
       fn: function(t){

         // Choose 4 to keep the same, 4 to be change but keep catery, and 4 to change but change category
         first_half = jsPsych.randomization.shuffle([0,1,2,3,4,5]);
         second_half = jsPsych.randomization.shuffle([6,7,8,9,10,11]);

         seen_items = [first_half[0], first_half[1], second_half[0], second_half[1]];
         unambiguous_items = [first_half[2], first_half[3], second_half[2], second_half[3]];
         ambiguous_items = [first_half[4], first_half[5], second_half[4], second_half[5]];
         unambiguous_items = unambiguous_items.map(num => num + 12);
         ambiguous_items = ambiguous_items.map(num => num + 24);

         all_items = seen_items.concat(ambiguous_items);
         all_items = all_items.concat(unambiguous_items);
         test_items = jsPsych.randomization.shuffle(all_items);
         return test_items

       }
}}




var debug = {
  type: jsPsychSurveyText,
  questions: [
    {prompt: 'Did you experience any issues while completing this study?', rows: 5}
    ]
}


  // Blocks



var instructions = {
    type: jsPsychInstructions,
    pages: [
    '<h1>Instructions</h1>In this study you will sort shapes into two categories. These categories are called "blickets" and "daxes".<br><br>Each of the shapes is either a "blicket" or a "daxe". <br><br>Your job is to learn to distinguish between blickets and daxes however you see fit.<br><br>There will be 6 training blocks where you will learn to categorise the shapes and receive feedback after each of your responses. After the training, there will be a test block.'
    ],
    show_clickable_nav: true,
    allow_backward: false
}


var new_trianing_block = {
  type: jsPsychInstructions,
  pages: function(){
    return ([
      '<h2>Training</h2> Block ' + blocknum + "/6"
    ])
  },
  show_clickable_nav: true,
  button_label_next: "Begin",
  allow_backward: false
}


var test_block_start = {
  type: jsPsychInstructions,
  pages: [
  'You will now complete the test block. There will be 12 test items. <b>Some of them you have seen before, some you have not</b><br>You will no longer receive feedback.'
  ],
  show_clickable_nav: true,
  button_label_next: "Begin",
  allow_backward: false

}



var NO_CR_training_set = {
  timeline: [new_trianing_block, NoCR_training_trial],
  repetitions: 6
}

var CR_training_set = {
  timeline: [new_trianing_block, CR_training_trial],
  repetitions: 6
}



// Set Condition


condition_1_timeline = [preload, participant_info_paid, participant_info_SONA, instructions, NO_CR_training_set, test_block_start, test_trial, debug, save_data, DEBRIEF_SONA];
condition_2_timeline = [preload, participant_info_paid, participant_info_SONA, instructions, CR_training_set, test_block_start, test_trial, debug, save_data, DEBRIEF_SONA];


async function createExperiment(){
  const condition = await jsPsychPipe.getCondition("NiAZxGe1LX8K");
  
  if(condition == 0) { timeline = condition_1_timeline; jsPsych.data.addProperties({condition: 'NoCR'});}
  if(condition == 1) { timeline = condition_2_timeline; jsPsych.data.addProperties({condition: 'CR'});}
  jsPsych.run(timeline);
}


createExperiment();




//welcome, demographics

  // Run the timeline
 // jsPsych.run([demographics, hello_trial, save_data]);





</script>
</html>
