<!DOCTYPE html>
<html>
<head>
  <title>USYD Metacognition</title>

  <!-- Load jsPsych and jquery-->
  <script src="https://unpkg.com/jspsych@7.2.1"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/js/foundation.min.js'></script>
  <link href="https://unpkg.com/jspsych@7.2.3/css/jspsych.css" rel="stylesheet" type="text/css" />


  <!-- Load jsPsych plugins-->
  <script src="https://unpkg.com/@jspsych/plugin-instructions@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-external-html@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.0"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>

  <!-- Load the global environment-->
  <script src="global-env.js"></script>
  <script src="info_sheets.js"></script>
  <script src="plugin-line-learning.js"></script>
  <script src="helper-functions.js"></script>

  <!-- Load custom plugins from directory-->




</head>
<body></body>
<script>



//////////////////////////////////
//         Gloabl Settings      //
//////////////////////////////////

// Initalise jsPsych
  const jsPsych = initJsPsych({
    on_finish: function(data) {
     window.location = redirect_link
   }
 })


// Settings





// Capture any url paramaters
  var PROLIFIC_PID = jsPsych.data.getURLVariable('PROLIFIC_PID');
  var SONA_PID = jsPsych.data.getURLVariable('SONAID');
  var redirect_link = null;


  if(typeof SONA_PID != 'undefined'){

    jsPsych.data.addProperties({participant_id: SONA_PID});
    jsPsych.data.addProperties({Source: "SONA"});
    console.log("sona")
    redirect_link = "https://sydneypsych.sona-systems.com/webstudy_credit.aspx?experiment_id=2953&credit_token=328b91e0da274cd187bf3a85b0ea3d08&survey_code=" + SONA_PID + "&id=" + SONA_PID;

  }


  if(typeof SONA_PID === 'undefined'){

    jsPsych.data.addProperties({participant_id: PROLIFIC_PID});
    jsPsych.data.addProperties({Source: "Prolific"});
    console.log("prolific")
    redirect_link ="https://app.prolific.com/submissions/complete?cc=CHGWKNI0"

  }


  
  // Save to OSF
  const subject_id = jsPsych.randomization.randomID(10);
  const filename = `${subject_id}.csv`;



  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "1hL57FnqrdBo",
    filename: filename,
    data_string: ()=>jsPsych.data.get().csv()
  };


//////////////////////////////////





 // Stimuli

  blocknum = 1;
  trialnum = 1;






  // Trials

  
  var colour_set= jsPsych.randomization.sampleWithoutReplacement([30,30,20,20],4)
  var mono_label  = jsPsych.randomization.sampleWithoutReplacement(["Blicket", "Snarg"],1)





  const line_trial = {
    type: jsPsychLineLearning,
    data: {test_type: "training"},
    category: jsPsych.timelineVariable('category'),
    line_lengths: function(){
      return jsPsych.randomization.sampleWithoutReplacement([3,8,13,18],3)
    },
    choices: ["Blicket", 'Snarg'],
    monotonic_label: mono_label,
    colour_prob: function(){

      if(jsPsych.timelineVariable('category') == 'Mono') return colour_set;
      if(jsPsych.timelineVariable('category') == 'noMono'){

        // Reversing the probabilities
        var nm1 = 50 - colour_set[0];
        var nm2 = 50 - colour_set[1];
        var nm3 = 50 - colour_set[2];
        var nm4 = 50 - colour_set[3];
        return [nm1, nm2, nm3, nm4];

      }


    },
    trial_duration: 8000

  }







  const feedback = {
    type: jsPsychHtmlKeyboardResponse,
    data: {test_type: "Feedback"},
    choices: "NO_KEYS",
    trial_duration: 1000,
    stimulus: function(data){
      
      var last_trial_correct = jsPsych.data.get().last(1).values()[0].accuracy;

      if(last_trial_correct){
      return "<p style = 'font-size: 22pt; color: green;'>Correct</p>"; // the parameter value has to be returned from the function
    } else {
      return "<p style = 'font-size: 22pt; color: red;'>Wrong</p>"; // the parameter value has to be returned from the function
    }
  }
}




// test block

const test_block = {

  timeline: [

  {
    type: jsPsychLineLearning,
    data: {test_type: "Baseline trials"},
     on_start: function(trial) {
      console.log("Baseline")
     },
    category: jsPsych.timelineVariable('category'),
   line_lengths: function(){
      return jsPsych.randomization.sampleWithoutReplacement([3,8,13,18],3)
    },
    choices: ["Blicket", 'Snarg'],
    monotonic_label: mono_label,
        colour_prob: function(){

      if(jsPsych.timelineVariable('category') == 'Mono') return colour_set;
      if(jsPsych.timelineVariable('category') == 'noMono'){

        // Reversing the probabilities
        var nm1 = 50 - colour_set[0];
        var nm2 = 50 - colour_set[1];
        var nm3 = 50 - colour_set[2];
        var nm4 = 50 - colour_set[3];
        return [nm1, nm2, nm3, nm4];

      }}


  },


  {
    type: jsPsychLineLearning,
    data: {test_type: "Relation test trials"},
    category: jsPsych.timelineVariable('category'),
         on_start: function(trial) {
      console.log("Relational")
     },
   line_lengths: function(){
      return jsPsych.randomization.sampleWithoutReplacement([3,8,13,18],3)
    },
    choices: ["Blicket", 'Snarg'],
    monotonic_label: mono_label,
    colour_prob: [25,25,25,25],
    empirical_col_probs: false

  },


  {
    type: jsPsychLineLearning,
    data: {test_type: "Feature test trials"},
         on_start: function(trial) {
      console.log("Feature")
     },
    category: jsPsych.timelineVariable('category'),
    line_lengths: function(){
     x = jsPsych.randomization.sampleWithoutReplacement([6,7,8,9,10,11,12,13,14,15,16,17,18],1)
     return [x[0],x[0],x[0]]
   },
   choices: ["Blicket", 'Snarg'],
   monotonic_label: mono_label,
      colour_prob: function(){

      if(jsPsych.timelineVariable('category') == 'Mono') return colour_set;
      if(jsPsych.timelineVariable('category') == 'noMono'){

        // Reversing the probabilities
        var nm1 = 50 - colour_set[0];
        var nm2 = 50 - colour_set[1];
        var nm3 = 50 - colour_set[2];
        var nm4 = 50 - colour_set[3];
        return [nm1, nm2, nm3, nm4];

      }}


 },


 {
  type: jsPsychLineLearning,
  data: {test_type: "Cross-mapped test trials"},
       on_start: function(trial) {
      console.log("Cross")
     },
  category: jsPsych.timelineVariable('category'),
   line_lengths: function(){
      return jsPsych.randomization.sampleWithoutReplacement([3,8,13,18],3)
    },
  choices: ["Blicket", 'Snarg'],
  monotonic_label: mono_label,
  colour_prob: function(){

      if(jsPsych.timelineVariable('category') == 'noMono') return colour_set;
      if(jsPsych.timelineVariable('category') == 'Mono'){
        var nm1 = 50 - colour_set[0];
        var nm2 = 50 - colour_set[1];
        var nm3 = 50 - colour_set[2];
        var nm4 = 50 - colour_set[3];
        return [nm1, nm2, nm3, nm4];

      }


    },

}


],
  timeline_variables: [
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"}
    ],
    randomize_order: true



}






const cat_JOL = {
  timeline: [
  {
    type: jsPsychHtmlSliderResponse,
    data: {trial_name: "cat_JOL"},
    stimulus: `<p>Please rate the likelihood that you will correctly indicate whether items are Blickets or a Snargs on a later test</p>`,
    require_movement: true,
    labels: ["0<br>(not at all)", "20", '40', '60', "80",'100<br>(definitely)']
  }

  ]
}




const wait = {
  timeline: [
  {
    type: jsPsychHtmlKeyboardResponse,
    data: {trial_name: "wait"},
    stimulus: "Take a rest while we load the next block...",
    choices: "NO_KEYS",
    trial_duration: 5000
  }

  ]
}

  // Blocks

const line_block_CR = {
  timeline: [line_trial, feedback, cat_JOL],
  on_timeline_finish: function() {
    blocknum = blocknum + 1;
  },
  timeline_variables: [
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"}
    ],
  sample: {
   type: 'custom',
   fn: function(t){
     return trippleTreat(t)


   }}
 }

 
 const line_block = {
  timeline: [line_trial, feedback],
  on_timeline_finish: function() {
    blocknum = blocknum + 1;
  },
  timeline_variables: [
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"},
    {category: "Mono"},
    {category: "noMono"}
    ],
  sample: {
   type: 'custom',
   fn: function(t){
     return trippleTreat(t)


   }}
 }
 


var hint = jsPsych.randomization.sampleWithoutReplacement(['<strong>Note: here&apos;s a hint for how to solve the task. Pay attention to the colors that appear in each pattern</strong>', '<strong>Note: here&apos;s a hint for how to solve the task. Compare the lengths of the lines that appear in each pattern</strong>', ''],1)


jsPsych.data.addProperties({hint: hint});


 var instructions = {
  type: jsPsychInstructions,
  pages: [
    '<h1>Instructions</h1>In this study you will sort geometric configurations into two categories.<br><img src="Screenshot.png" style="width:500px;height:600px;"><br>These categories are called "blickets" and "snargs".<br><br>Each configuration is either a "blicket" or a "snarg". <br><br>Your job is to learn to distinguish between blickets and snargs however you see fit.<br><br>There will be 6 training blocks where you will learn to categorise the configurations and receive feedback after each of your responses. After the training, there will be a test block.',
    hint + '<br>Press Next when you are ready to begin'
    ],
  show_clickable_nav: true,
  allow_backward: false
}


var new_trianing_block = {
  type: jsPsychInstructions,
  pages: function(){
    return ([
      '<h2>Training</h2> Block ' + blocknum + "/6"
      ])
  },
  show_clickable_nav: true,
  button_label_next: "Begin",
  allow_backward: false
}


var test_block_start = {
  type: jsPsychInstructions,
  pages: [
    'You will now complete the test block. There will be 32 test items. You will no longer receive feedback.'
    ],
  show_clickable_nav: true,
  button_label_next: "Begin",
  allow_backward: false

}

var debug = {
  type: jsPsychSurveyText,
  questions: [
    {prompt: 'Did you experience any issues while completing this study?', rows: 5}
    ]
}




// Set Condition

pilot_timeline = [line_block, test_block, save_data, DEBRIEF_SONA];

condition_1_timeline = [participant_info_paid, participant_info_SONA, instructions, new_trianing_block, line_block_CR, new_trianing_block, line_block_CR, new_trianing_block, line_block_CR, new_trianing_block, line_block_CR, new_trianing_block, line_block_CR, new_trianing_block, line_block_CR, test_block_start, test_block, debug, save_data, DEBRIEF_SONA];

condition_2_timeline = [participant_info_paid, participant_info_SONA, instructions, new_trianing_block, line_block, new_trianing_block, line_block, new_trianing_block, line_block, new_trianing_block, line_block, new_trianing_block, line_block, new_trianing_block, line_block, test_block_start, test_block, debug, save_data, DEBRIEF_SONA];

exp_condition = null;
async function createExperiment(){
  const condition = await jsPsychPipe.getCondition("1hL57FnqrdBo");
  if (condition == 0){jsPsych.data.addProperties({condition: "JOL"});}
  if (condition == 1){jsPsych.data.addProperties({condition: "Control"});}



  if(condition == 0) { timeline = condition_1_timeline; }
  if(condition == 1) { timeline = condition_2_timeline; }

  
  
  exp_condition = condition
  jsPsych.run(timeline);
}


createExperiment();




//welcome, demographics

  // Run the timeline
 // jsPsych.run([demographics, hello_trial, save_data]);





</script>
</html>
